<?xml version="1.0"?>
<!--
    * release
        1. release
        2. release-publish
        3. release-publish-snapshots
-->

<project name="osha-dvt" basedir="." default="remote-copy">

    <property file="jenkins_build.properties"/>

    <!--
        release vars
    -->
    <property name="release_solution_name"      value="osha-dvt-ilo"/>
    <property name="release-dir"                value="/opt/pentaho/biserver-ce/pentaho-solutions/system/"/>

    <!--
            jenkins vars
            - release;      jenkins-environment
    -->
    <property name="jenkins-environment"        value="local"/>
    <property name="do_track"                   value="false"/>
    <property name="packed"                     value="false"/>
    <property name="cache"                      value="false"/>
    <property name="seo"                        value="false"/>
    <property name="wipeLibraries"              value="false"/>

    <echo>jenkins-environment: ${jenkins-environment}</echo>
    <echo>do_track: ${do_track}</echo>
    <echo>packed: ${packed}</echo>
    <echo>cache: ${cache}</echo>
    <echo>seo: ${seo}</echo>

    <!--
            jenkins commands to have installed
            - npm
            - bower
    -->

    <!--
        environment constants
    -->

    <property name="solution_name"      value="osha-dvt-ilo"/>
    <property name="db_name"            value="osha_dvt_ilo"/>

    <tstamp>
        <format property="ts" pattern="yyyyMMdd-HHmmss"/>
    </tstamp>

    <!--
        =========================
            solution prepare
        =========================
    -->
    <target name="clean">
        <delete dir="jenkins_dist"/>
    </target>

    <target name="clean-prepare" depends="clean, clean-modules">
        <delete dir="static/system/components"/>
        <delete dir="resources-ext/documentation"/>
        <delete>
            <fileset dir="static/custom" includes="**/*.min.js"/>
        </delete>
    </target>

    <target name="clean-modules" if="${wipeLibraries}">
        <delete dir="node_modules"/>
    </target>

    <target name="setup-modules" if="${wipeLibraries}">
        <exec executable="node" spawn="false">
            <arg value="-v"/>
        </exec>
        <exec executable="npm" spawn="false">
            <arg value="install"/>
        </exec>
    </target>

    <target name="local-prepare" depends="clean-prepare, setup-modules">
        <exec executable="gulp" spawn="false">
            <arg value="bower"/>
        </exec>
        <exec executable="gulp" spawn="false">
            <arg value="dvt-sass"/>
        </exec>

        <exec executable="gulp" spawn="false">
            <arg value="ci-environment"/>
            <arg value="--pentaho"/>
            <arg value="${jenkins-environment}"/>
            <arg value="--piwik"/>
            <arg value="${jenkins-environment}"/>
            <arg value="--do_track"/>
            <arg value="${do_track}"/>
            <arg value="--packed"/>
            <arg value="${packed}"/>
            <arg value="--cache"/>
            <arg value="${cache}"/>
            <arg value="--seo"/>
            <arg value="${seo}"/>
        </exec>
        <exec executable="gulp" spawn="false">
            <arg value="setup-environment"/>
        </exec>
    </target>


    <target name="prepare" depends="local-prepare">

        <exec executable="gulp" spawn="false">
            <arg value="clean-min"/>
        </exec>
        <exec executable="gulp" spawn="false">
            <arg value="documentation"/>
            <arg value="--documentation"/>
            <arg value="${documentation}"/>
        </exec>
        <exec executable="gulp" spawn="false">
            <arg value="package"/>
            <arg value="--packed"/>
            <arg value="${packed}"/>
        </exec>
        <exec executable="gulp" spawn="false">
            <arg value="cache"/>
            <arg value="--cache"/>
            <arg value="${cache}"/>
        </exec>

    </target>

    <target name="prepare-dist">
        <mkdir dir="jenkins_dist"/>
        <copy todir="jenkins_dist/${solution_name}">
            <fileset dir=".">
                <exclude name="**/**build**/**"/>
                <exclude name="**/jenkins_dist/**"/>
                <exclude name="**/resources-ext/**"/>
                <exclude name="**/static/custom/seo/snapshots/**"/>
            </fileset>
        </copy>
        <!-- add resources-ext content -->
        <copy file="resources-ext/dbdump/${db_name}.sql" todir="jenkins_dist/${solution_name}/resources-ext/dbdump/"/>
        <copy todir="jenkins_dist/${solution_name}/resources-ext/pentaho-610-extension">
            <fileset dir="resources-ext/pentaho-610-extension"/>
        </copy>
        <copy todir="jenkins_dist/${solution_name}/resources-ext/pentaho-610-extension-original">
            <fileset dir="resources-ext/pentaho-610-extension-original"/>
        </copy>
        <copy todir="jenkins_dist/${solution_name}/resources-ext/apache">
            <fileset dir="resources-ext/apache"/>
        </copy>
    </target>

    <!--
        =========================
            release
        =========================
    -->
    <target name="release" depends="prepare, prepare-dist">
        <zip destfile="jenkins_dist/${release_solution_name}-${release_solution_version}.zip" basedir="jenkins_dist"/>
    </target>

    <target name="release-publish" depends="release">
        <delete dir="${release-dir}/${release_solution_name}"/>
        <unzip src="jenkins_dist/${release_solution_name}-${release_solution_version}.zip" dest="${release-dir}"/>
    </target>

    <target name="release-publish-snapshots">
        <zip destfile="jenkins_dist/${release_solution_name}-${release_solution_version}-snapshots.zip" basedir="static/custom/seo/snapshots"/>
        <copy file="jenkins_dist/${release_solution_name}-${release_solution_version}-snapshots.zip" 	todir="${release-dir}" overwrite="false" verbose="true"/>
    </target>
</project>